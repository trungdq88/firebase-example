<h1>Welcome, <span id="lblUsername"></span></h1>
<input id="txtValue" />
<input id="btnFacebook" type="button" value="Facebook" />
<input id="btnLogout" type="button" value="Log Out" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.1.0/rx.lite.js"></script>
<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCpQjFy_vv-bMZzel-NWu44v1vZGCL8uxE",
    authDomain: "fir-example-c2211.firebaseapp.com",
    databaseURL: "https://fir-example-c2211.firebaseio.com",
    storageBucket: "",
  };
  firebase.initializeApp(config);

  // Get a reference to the database service
  var database = firebase.database();
  const ref = firebase.database().ref('/');
  
  // Observables
  const obsValueChange = new Rx.Subject();
  const obsAuthStateChange = new Rx.Subject();
  const obsAuthLoggedIn = obsAuthStateChange.filter(user => user !== null);
  const obsAuthLoggedOut = obsAuthStateChange.filter(user => user === null);

  // Binding Rx for Firebase
  ref.on('value', function(snapshot) {
    obsValueChange.onNext(snapshot);
  });

  firebase.auth().onAuthStateChanged(user => {
    obsAuthStateChange.onNext(user);
  });

  ///////////////
  // Handle input
  ///////////////
  Rx.Observable.fromEvent(txtValue, 'keyup')
  .map(e => e.target.value)
  .distinctUntilChanged()
  .subscribe(val => ref.set(val));

  obsValueChange
  .map(snapshot => snapshot.val())
  .subscribe(val => txtValue.value = val);

  ///////////////
  // Authenticate
  ///////////////
  obsAuthLoggedIn.subscribe(user => {
    var user = firebase.auth().currentUser;
    lblUsername.innerText = user.displayName;
  });

  obsAuthLoggedOut.subscribe(() => {
    lblUsername.innerText = 'Guest';
  });

  Rx.Observable.fromEvent(btnFacebook, 'click')
  .subscribe(e => firebase.auth().signInWithPopup(new firebase.auth.FacebookAuthProvider()));

  Rx.Observable.fromEvent(btnLogout, 'click')
  .subscribe(e => firebase.auth().signOut());
</script>
